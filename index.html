<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SRC20 Dashboard</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />

    <style type="text/css">
        .info-btn { cursor: pointer;}
    </style>
</head>
    <body>
        <div class="container mb-3">
            <h3 id="header">SRC20 Dashboard</h3>

            <hr />

            <p>
                Current conditions:
                <ul>
                    <li>Amounts > 420k fallback to 420k per mint</li>
                    <li>Casing doesn't matter, so KeViN, KEVIN and Kevin are all valid</li>
                    <li>Stamp has to have: keyburn = true, locked = true, quantity = 0</li>
                    <li>Mints after the deploy are valid, mints before deploy aren't</li>
                </ul>
            </p>

            <hr />
        </div>

        <div class="container mb-5">
            <div id="result">
                <img src="img/loading.gif" title="loading.." style="display: block; margin: 0 auto;"/>
            </div>
        </div>
        
        <div class="container text-center">
            <footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
                <div class="col-md-12 d-flex align-items-center">
                    <span class="text-muted">Made by obi, source: <a target="_blank" href="https://github.com/crypt0biwan/src20">github</a>, contact: <a target="_blank" href="https://twitter.com/crypt0biwan">twitter</a>, donations: 1obiAgwKHdqrv135uzHH81Pz7MGG1sqvw</span>
                </div>
            </footer>
        </div>

        <script src="js/bootstrap.bundle.min.js"></script>
        <script src="js/lodash.min.js"></script>
        <script src="js/tablesort.min.js"></script>
        <script src="js/tablesort.number.min.js"></script>
        <script>
            // const stamp_json = 'json/src20.json'
            const stamp_json = 'https://stampchain.io/api/src20'

            let src20s = []
            let tokens = []

            const header = document.querySelector('#header')
            const result = document.querySelector('#result')

            const b64_to_utf8 = str => decodeURIComponent(escape(window.atob(str)))

            const formatValue = (value, decimals = 0, style = 'decimal') =>
                new Intl.NumberFormat('en-US', {
                    style,
                    currency: 'USD',
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals,
                }).format(value)
                            
            const get_stamps = () => fetch(`${stamp_json}`).then((response) => response.json()).catch(e => {
                console.log(e)
                result.innerHTML = `<div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i> Couldn't fetch Stampchain API
                </div>`
            })

            const get_mints = ticker => _.filter(_.orderBy(src20s, ['tx_index'], ['asc']), src20 => src20.tick.toUpperCase() === ticker.toUpperCase() && src20.op === 'mint')

            const get_amount_minted = tick => {
                const token = _.filter(tokens, token => token.tick.toUpperCase() === tick.toUpperCase())[0]

                const {
                    tx_index: tokenStamp,
                    max,
                    lim,
                } = token

                let total_tokens = 0
                let amount_of_mints = 0
                let mint_info = {}

                _.each(get_mints(tick), mint => {
                    let {
                        tx_index: mintStamp,
                        amt,
                    } = mint

                    if(tokenStamp < mintStamp) {
                        if(_.parseInt(amt) > _.parseInt(lim)) {
                            amt = _.parseInt(lim)
                        }

                        if(total_tokens + _.parseInt(amt) <= max) {
                            amount_of_mints++
                            total_tokens += _.parseInt(amt)
                        }
                    }                   
                })

                return {
                    amount_of_mints,
                    total_tokens
                }
            }

            const get_mints_html = (tick) => {
                const token = _.filter(tokens, token => token.tick.toUpperCase() === tick.toUpperCase())[0]

                const {
                    tx_index: tokenStamp,
                    max,
                    lim,
                } = token

                let htmlValidTableStart = 
                    `<table id="tokens" class="table table-striped table-sm mb-5" style="text-align: left; font-weight: 400;">
                        <thead>
                            <tr>
                                <th style="text-align: right; padding-right: 20px;" scope="col">ID</th>
                                <th style="text-align: right; padding-right: 20px;" scope="col">Tx index</th>
                                <th scope="col">Creator</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Amount</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Total</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">%</th>
                            </tr>
                        </thead>
                    <tbody>`

                let htmlInvalidTableStart = 
                    `<table id="tokens" class="table table-striped mb-5" style="text-align: left;">
                        <thead>
                            <tr>
                                <th style="text-align: right; padding-right: 20px;" scope="col">ID</th>
                                <th style="text-align: right; padding-right: 20px;" scope="col">Tx index</th>
                                <th scope="col">Creator</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Amount</th>
                            </tr>
                        </thead>
                    <tbody>`         

                let htmlValid = ``
                let htmlInvalid = ``
                let total_tokens = 0

                _.each(get_mints(tick), (mint, index) => {
                    const {
                        tx_index: mintStamp,
                        op,
                        block_index,
                        creator,
                        amt,
                        tx_hash,
                        p
                    } = mint

                    if(tokenStamp < mintStamp) {
                        let newAmount = false

                        if(_.parseInt(amt) > _.parseInt(lim)) {
                            newAmount = _.parseInt(lim)
                        }

                        if(total_tokens + _.parseInt(amt) <= max) {
                            total_tokens += newAmount ? newAmount : _.parseInt(amt)

                            htmlValid += `<tr>
                                <td style="text-align: right; padding-right: 20px;">
                                    ${formatValue(index + 1)}
                                </td>
                                <td style="text-align: right; padding-right: 20px;">
                                    ${formatValue(mintStamp)}
                                </td>
                                <td>
                                    ${creator}
                                </td>
                                <td style="text-align: right; padding-right: 50px; white-space: nowrap;">
                                    ${newAmount ? `<del>${formatValue(amt)}</del> <i class="bi bi-arrow-right-circle-fill"></i> ${formatValue(newAmount)}` : formatValue(amt)}
                                </td>
                                <td style="text-align: right; padding-right: 50px;">
                                    ${formatValue(total_tokens)}
                                </td>
                                <td style="text-align: right; padding-right: 50px;">
                                    ${parseFloat(100 / max * total_tokens).toFixed(2)}&nbsp;%
                                </td>
                            </tr>`

                        } else {
                            htmlInvalid += `<tr>
                                <td style="text-align: right; padding-right: 20px;">
                                    ${formatValue(index + 1)}
                                </td>
                                <td style="text-align: right; padding-right: 20px;">
                                    ${formatValue(mintStamp)}
                                </td>
                                <td>
                                    ${creator}
                                </td>
                                <td style="text-align: right; padding-right: 50px;">
                                    ${formatValue(amt)}
                                </td>
                            </tr>`
                        }

                    }
                })
                
                let htmlTableEnd =
                    `</tbody>
                    </table>`

                let html = `<h5 style="text-align: left;">Valid mints <i class="bi bi-check-circle-fill"></i></h5>
                
                    ${htmlValidTableStart}
                    ${htmlValid}
                    ${htmlTableEnd}
                `

                if(htmlInvalid) {
                    html += `<h5 style="text-align: left;">Invalid mints <i class="bi bi-x-circle-fill"></i></h5>

                        ${htmlInvalidTableStart}
                        ${htmlInvalid}
                        ${htmlTableEnd}
                    `   
                }
                
                return html
            }

            const parse_tokens = () => {
                _.each(_.filter(src20s, src20 => src20.op === 'deploy'), src20 => {
                    const {
                        tick,
                        max,
                        lim
                    } = src20

                    if(!_.filter(tokens, token => token.tick.toUpperCase() === tick.toUpperCase()).length) {
                        tokens.push(src20)
                    }
                })
            }

            const get_table_html = () => {
                let html = 
                    `<table id="tokens" class="table table-striped mb-5">
                        <thead>
                            <tr>
                                <th style="text-align: right; padding-right: 20px;" scope="col">ID</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Stamp</th>
                                <th scope="col">Tick</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Lim</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Mints</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Total</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">Max</th>
                                <th style="text-align: right; padding-right: 50px;" scope="col">%</th>
                            </tr>
                        </thead>
                    <tbody>`

                _.each(tokens, (token, index) => {
                    const {
                        tx_index: stamp,
                        tick,
                        max,
                        lim
                    } = token

                    const {
                        amount_of_mints,
                        total_tokens
                    } = get_amount_minted(tick)

                    html += 
                    `<tr>
                        <td style="text-align: right; padding-right: 20px;">
                            ${index+1}
                        </td>
                        <td style="text-align: right; padding-right: 50px;">
                            ${formatValue(stamp)}
                        </td>
                        <td>
                            ${tick}
                        </td>
                        <td style="text-align: right; padding-right: 50px;">
                            ${formatValue(lim)}
                        </td>
                        <td style="text-align: right; padding-right: 50px; white-space: nowrap;">
                            ${formatValue(amount_of_mints)}
                            
                            <span class="text-primary">
                                <i class="info-btn bi bi-info-circle-fill" data-bs-toggle="modal" data-bs-target="#modal${index}"></i>
                            </span>

                            <div class="modal fade" id="modal${index}" tabindex="-1" aria-labelledby="modal${tick}" aria-hidden="true" style="display: none;">
                                <div class="modal-dialog modal-xl">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h1 class="modal-title fs-4" id="gridModalLabel">${tick} mint info</h1>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        
                                        <div class="modal-body">
                                            <div>
                                                ${get_mints_html(tick)}
                                            </div>
                                        </div>

                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: right; padding-right: 50px;">
                            ${formatValue(total_tokens)}
                        </td>
                        <td style="text-align: right; padding-right: 50px;">
                            ${formatValue(max)}
                        </td>
                        <td style="text-align: right; padding-right: 50px;">
                            ${formatValue(100 / max * total_tokens, 2)}&nbsp;%
                        </td>
                    </tr>`
                })

                html +=
                    `</tbody>
                    </table>`
                
                return html    
            }

            const init = async () => {
                let resp = await get_stamps()

                if(resp) {
                    src20s = _.orderBy((resp), ['tx_index'], ['asc'])

                    parse_tokens()

                    result.innerHTML = get_table_html()

                    new Tablesort(document.getElementById('tokens'))
                }
            }

            init()
        </script>        
    </body>
</html>